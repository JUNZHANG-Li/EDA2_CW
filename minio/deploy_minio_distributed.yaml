# filename: deploy_minio_distributed.yaml (Add User Creation)
---
- name: Deploy MinIO Server in Distributed Mode on Workers using RPM
  hosts: workers
  become: true

  vars:
    minio_rpm_url: "https://dl.min.io/server/minio/release/linux-amd64/minio.rpm"
    minio_service_name: "minio"
    minio_data_dir: "/data/minio-data"
    minio_root_user: "minioadmin" # CHANGE THIS
    minio_root_password: "minioStrongPassword123" # CHANGE THIS
    minio_env_file: "/etc/default/minio" # VERIFY THIS PATH!
    minio_service_user: "minio-user" # User the service will run as
    minio_service_group: "minio-user" # Group the service will run as
    local_env_template: "./templates/minio_env.j2"

  tasks:
    - name: Ensure essential packages are present
      ansible.builtin.package:
        name:
         - wget
         - policycoreutils-python-utils
        state: present
        update_cache: yes
      ignore_errors: yes

    # --- Install MinIO via RPM ---
    - name: Install MinIO from RPM URL
      ansible.builtin.dnf: # Or yum
        name: "{{ minio_rpm_url }}"
        state: present
        disable_gpg_check: yes
      register: rpm_install_result

    # --- ADDED: Explicit User and Group Creation ---
    - name: Ensure MinIO service group exists
      ansible.builtin.group:
        name: "{{ minio_service_group }}"
        state: present
        system: yes # Mark as system group

    - name: Ensure MinIO service user exists
      ansible.builtin.user:
        name: "{{ minio_service_user }}"
        group: "{{ minio_service_group }}"
        system: yes # Mark as system user
        create_home: no # No home directory needed
        shell: /sbin/nologin # Prevent login
        state: present
    # --- END ADDED USER/GROUP CREATION ---

    # --- Configure Environment Variables ---
    - name: Ensure MinIO environment directory exists
      ansible.builtin.file:
        path: "{{ minio_env_file | dirname }}"
        state: directory
        mode: '0755'

    - name: Configure MinIO environment variables
      ansible.builtin.template:
        src: "{{ local_env_template }}"
        dest: "{{ minio_env_file }}"
        owner: root
        group: root
        mode: '0640'
      register: minio_env_config

    # --- Prepare Storage Directory ---
    - name: Ensure MinIO data directory exists on /data mount with correct ownership
      ansible.builtin.file:
        path: "{{ minio_data_dir }}"
        state: directory
        owner: "{{ minio_service_user }}"  # Should now succeed
        group: "{{ minio_service_group }}" # Should now succeed
        mode: '0770' # Give user/group rwx, deny others explicitly

    # Optional: SELinux context tasks (remain the same)
    - name: Set SELinux context for MinIO data directory (if SELinux is enforcing)
      # ... (task content same as before) ...
      ansible.builtin.sefcontext:
        target: '{{ minio_data_dir }}(/.*)?'
        setype: 'minio_var_lib_t'
        state: present
      notify: Restore SELinux Contexts
      ignore_errors: yes

    - name: Apply SELinux context changes immediately
      # ... (task content same as before) ...
      ansible.builtin.command: "restorecon -R -v {{ minio_data_dir }}"
      changed_when: false
      when: ansible_selinux is defined and ansible_selinux.status == "enabled" and ansible_selinux.mode == "enforcing"
      ignore_errors: yes

    # --- Start and Enable Service ---
    - name: Reload systemd daemon (if env file changed)
      ansible.builtin.systemd:
        daemon_reload: yes
      when: minio_env_config.changed # Only reload if necessary

    - name: Enable and ensure MinIO service is started
      ansible.builtin.systemd:
        name: "{{ minio_service_name }}"
        state: started
        enabled: yes

    - name: Restart MinIO service if environment variables changed
      ansible.builtin.systemd:
        name: "{{ minio_service_name }}"
        state: restarted
      when: minio_env_config.changed

    - name: Wait briefly for service to initialize
      ansible.builtin.pause:
        seconds: 15

    # --- Verification ---
    - name: Check MinIO service status
      ansible.builtin.command: "systemctl is-active {{ minio_service_name }}"
      register: minio_status
      changed_when: false
      failed_when: minio_status.rc != 0

    - name: Display MinIO status and access info
      ansible.builtin.debug:
        msg:
          - "{{ minio_service_name }} service is active on {{ inventory_hostname }}."
          - "Access API/Client via: http://{{ ansible_default_ipv4.address }}:9000"
          - "Access Console via: http://{{ ansible_default_ipv4.address }}:9001"
          - "Use User: {{ minio_root_user }} / Pass: [REDACTED - Use Vault!]"
      when: minio_status.rc == 0

  # --- Optional Handler for SELinux ---
  handlers:
    - name: Restore SELinux Contexts
      ansible.builtin.command: "restorecon -R -v {{ minio_data_dir }}"
      listen: Restore SELinux Contexts